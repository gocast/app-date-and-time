<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../moment-import/moment-with-locales.html">
<link rel="import" href="../moment-import/moment-timezone.html">
<link rel="import" href="../analog-clock/analog-clock.html">
<link rel="import" href="../fitted-text/fitted-text.html">

<dom-module id="app-date-and-time-player">
  <template>
    <style>
      :host {
        box-sizing: border-box;
        display: inline-block;
        padding: 2%;
        contain: strict;
        overflow: hidden;
      }

      /* analog-clock block */
      analog-clockÂ {
        @apply --layout-horizontal;
        @apply --layout-center-center;
        width: 100%;
        transition: width 0.01s, height 0.01s;
      }

      /* digital-clock block */
      .digital-clock {
        @apply --layout-vertical;
        @apply --layout-center-center;
        box-sizing: border-box;
        font-size: 4vw;
        padding-top: 2%;
        transition: width 0.01s, height 0.01s;
        width: 100%;
        position: relative
      }

      .digital-clock__time {
        width: 90%;
        height: 50%;
      }
      .digital-clock__date {
        width: 90%;
        height: 50%;
      }
    </style>

    <dom-if if="[[showAnalogClock]]">
      <template>
        <analog-clock
            style$="[[_computeAnalogClockHeight(showDigitalClock)]]"
            date="[[_computeDate(_currentTime)]]"
            show-seconds="[[showSeconds]]"
            on-transitionend="_updateSizes">
        </analog-clock>
      </template>
    </dom-if>

    <dom-if if="[[showDigitalClock]]">
      <template>
        <div
            class="digital-clock"
            style$="[[_computeDigitalClockHeight(showAnalogClock)]]"
            on-transitionend="_updateSizes">

          <dom-if if="[[_computeShowDate(showWeekDay, showDate)]]">
            <template>
              <fitted-text data-id="digitalDate" class="digital-clock__date"></fitted-text>
            </template>
          </dom-if>

          <dom-if if="[[showTime]]">
            <template>
              <fitted-text data-id="digitalTime" class="digital-clock__time"></fitted-text>
            </template>
          </dom-if>
        </div>
      </template>
    </dom-if>

  </template>
  <script>

    class AppDateAndTimePlayer extends Polymer.Element {

      static get is() {return 'app-date-and-time-player';}

      static get config() {
        return {
          properties: {

            timezone: String,

            showAnalogClock: {
              type: Boolean,
              observer: '_showAnalogClock',
            },

            showDigitalClock: Boolean,

            showTime: {
              type: Boolean,
              observer: '_showTimeChanged',
            },

            showSeconds: Boolean,

            showWeekDay: Boolean,

            showDate: {
              type: Boolean,
              observer: '_showDateChanged',
            },

            useTwentyFourHours: Boolean,

            padding: Number,

            _currentTime: Object,

            _currentTimeInterval: Number,

            /**
             * @type {HTMLElement}
             */
            _digitalDate: Object,

            /**
             * @type {HTMLElement}
             */
            _digitalTime: Object,

          },

          observers: [
            '_paddingChanged(padding, _digitalDate, _digitalTime)',
            '_digitalDateChanged(_currentTime, showWeekDay, showDate)',
            '_digitalTimeChanged(_currentTime, useTwentyFourHours, showSeconds, showTime)',
          ]
        };
      }

      connectedCallback() {
        super.connectedCallback();
        this._startTime();
      }

      disconnectedCallback() {
        super.disconnectedCallback();
        this._stopTime();
      }

      get digitalDate() {
        if (!this._digitalDate) {
          this._digitalDate = this.root.querySelector('[data-id=digitalDate]');
        }
        return this._digitalDate;
      }

      get digitalTime() {
        if (!this._digitalTime) {
          this._digitalTime = this.root.querySelector('[data-id=digitalTime]');
        }
        return this._digitalTime;
      }

      _paddingChanged(padding, digitalDate, digitalTime) {
        // 20% width minimun
        const width = Math.max(20, 100 - padding);
        const widthStyle = `${width}%`;

        if (digitalDate) {
          digitalDate.style.width = widthStyle;
        }
        if (digitalTime) {
          digitalTime.style.width = widthStyle;
        }
      }

      _showAnalogClock(showAnalogClock) {
        if (this.digitalTime) {
          this.digitalTime.innerHTML = '';
        }

        if (this.digitalDate) {
          this.digitalDate.innerHTML = '';
        }
      }

      _showTimeChanged(showTime) {
        // Clear text when hidden to prevent flush of invalid text while
        // updating text sizes
        if (!showTime && this.digitalTime) {
          this.digitalTime.innerHTML = '';
        }
      }

      _showDateChanged(showDate) {
        // Clear text when hidden to prevent flush of invalid text while
        // updating text sizes
        if (!showDate && this.digitalDate) {
          this.digitalDate.innerHTML = '';
        }
      }

      _digitalDateChanged(_currentTime, showWeekDay, showDate) {
        if (!_currentTime) {return;}
        if (!showWeekDay && !showDate) {return;}

        let prefix = '';

        if (showWeekDay) {
          prefix += _currentTime.format('dddd');
          if (showDate) {
            prefix += ', ';
          }
        }

        if (showDate) {
          prefix += _currentTime.format('DD MMMM');
        }

        if (this.digitalDate) {
          requestAnimationFrame(_ => {
            this.digitalDate.scale(prefix);
          });
        }
      }

      _digitalTimeChanged(_currentTime, useTwentyFourHours, showSeconds, showTime) {
        if (!showTime || !_currentTime) {return;}

        let format = '';

        if (useTwentyFourHours) {
          format += 'H:HH';
        } else {
          format += 'h:hh';
        }

        if (showSeconds) {
          format += ':ss';
        }

        if (this.digitalTime) {
          requestAnimationFrame(_ => {
            this.digitalTime.scale(_currentTime.format(format));
          });
        }
      }

      _startTime() {
        this._currentTime = moment(new Date());
        this._currentTimeInterval = setInterval(_ => {
          this._currentTime = moment(new Date());
        }, 500);
      }

      _stopTime() {
        if (this._currentTimeInterval) {
          clearTimeout(this._currentTimeInterval);
          this._currentTimeInterval = null;
        }
      }

      _updateSizes() {
        if (this.showAnalogClock) {
          const analogClock = this.shadowRoot.querySelector('analog-clock');
          const rect = analogClock.getBoundingClientRect();
          analogClock.width = rect.height;
        }
      }

      _computeShowDate(showWeekDay, showDate) {
        return showWeekDay || showDate;
      }

      _computeAnalogClockHeight(showDigitalClock) {
        if (showDigitalClock) {
          return 'height: 65%';
        }
        return 'height: 100%';
      }

      _computeDigitalClockHeight(showAnalogClock) {
        setTimeout(_ => this._updateSizes());

        if (showAnalogClock) {
          return 'height: 35%';
        }
        return 'height: 100%';
      }

      _computeDate(_currentTime) {
        return _currentTime.toDate();
      }

    }

    customElements.define(AppDateAndTimePlayer.is, AppDateAndTimePlayer);

  </script>
</dom-module>
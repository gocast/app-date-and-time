<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../moment-import/moment-with-locales.html">
<link rel="import" href="../moment-import/moment-timezone.html">
<link rel="import" href="../analog-clock/analog-clock.html">

<dom-module id="app-date-and-time-player">
  <template>
    <style>
      :host {
        box-sizing: border-box;
        display: inline-block;
        padding: 2%;
      }

      /* analog-clock block */
      analog-clockÂ {
        @apply --layout-horizontal;
        @apply --layout-center-center;        
        width: 100%;
        transition: width 0.01s, height 0.01s;
      }

      /* digital-clock block */
      .digital-clock {
        @apply --layout-vertical;
        @apply --layout-center-center;
        box-sizing: border-box;
        font-size: 4vw;
        padding-top: 2%;
        transition: width 0.01s, height 0.01s;
        width: 100%;
      }

      .digital-clock__date {
        white-space: nowrap;
      }
    </style>

    <dom-if if="[[showAnalogClock]]">
      <template>
        <analog-clock
            style$="[[_computeAnalogClockHeight(showDigitalClock)]]"
            date="[[_computeDate(_currentTime)]]"
            show-seconds="[[showSeconds]]"
            on-transitionend="_updateSizes">
        </analog-clock>
      </template>
    </dom-if>

    <dom-if if="[[showDigitalClock]]">
      <template>
        <div
            class="digital-clock"
            style$="[[_computeDigitalClockHeight(showAnalogClock)]]"
            on-transitionend="_updateSizes">
          <div class="digital-clock__date">
            [[_computeDigitalClockPrefix(_currentTime, showWeekDay, showDate)]]
          </div>
          <div class="digital-clock__time">
            [[_computeDigitalTime(_currentTime, useTwentyFourHours, showSeconds)]]
          </div>
        </div>
      </template>
    </dom-if>

  </template>
  <script>

    class AppDateAndTimePlayer extends Polymer.Element {

      static get is() {return 'app-date-and-time-player';}

      static get config() {
        return {
          properties: {
            
            timezone: String,

            showDigitalClock: Boolean,

            showAnalogClock: Boolean,

            useTwentyFourHours: Boolean,

            showSeconds: Boolean,
            
            showWeekDay: Boolean,

            showDate: Boolean,

            _currentTime: Object,

            _currentTimeInterval: Number

          }
        };
      }

      connectedCallback() {
        super.connectedCallback();
        this._startTime();
      }

      disconnectedCallback() {
        super.disconnectedCallback();
        this._stopTime();
      }

      _startTime() {
        this._currentTime = moment(new Date());

        this._currentTimeInterval = setInterval(_ => {
          this._currentTime = moment(new Date());
        }, 500);
      }

      _stopTime() {
        if (this._currentTimeInterval) {
          clearTimeout(this._currentTimeInterval);
          this._currentTimeInterval = null;
        }
      }

      _updateSizes() {
        if (this.showAnalogClock) {
          const analogClock = this.shadowRoot.querySelector('analog-clock');
          const rect = analogClock.getBoundingClientRect();
          analogClock.width = rect.height;
        }
      }

      _computeDigitalClockPrefix(_currentTime, showWeekDay, showDate) {
        let prefix = '';

        if (showWeekDay) {
          prefix += _currentTime.format('dddd');
          if (showDate) {
            prefix += ', ';
          }
        }

        if (showDate) {
          prefix += _currentTime.format('DD MMMM');
        }

        return prefix;
      }

      _computeDigitalTime(_currentTime, useTwentyFourHours, showSeconds) {
        let format = '';
  
        if (useTwentyFourHours) {
          format += 'H:HH';
        } else {
          format += 'h:hh';
        }

        if (showSeconds) {
          format += ':ss';
        }

        return _currentTime.format(format);
      }

      _computeAnalogClockHeight(showDigitalClock) {
        if (showDigitalClock) {
          return 'height: 65%';
        }
        return 'height: 100%';
      }

      _computeDigitalClockHeight(showAnalogClock) {
        if (showAnalogClock) {
          return 'height: 35%';
        }
        return 'height: 100%';
      }

      _computeDate(_currentTime) {
        return _currentTime.toDate();
      }
 
    }

    customElements.define(AppDateAndTimePlayer.is, AppDateAndTimePlayer);

  </script>
</dom-module>